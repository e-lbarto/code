<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BirdNET-pi Zirndorf</title>

<style>
  body { 
    zoom: 0.85;
    font-family: system-ui, sans-serif; 
    margin:0; 
    background:#77C487; 
    color:#333; 
    font-size:1.25em; 
  }

  header {
    position: relative;
    padding:16px;
    font-weight:bold;
    font-size:0.98em;
    background:#fff;
    border-bottom:1px solid #333;
    color:#333;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  header .logo {
    position: absolute;
    left:16px;
    top:50%;
    transform:translateY(-50%);
    height:40px;
  }

  header .header-text {
    margin:0;
    text-align: center;
    flex-grow: 1;
  }

  header .logo2-link {
    position: absolute;
    right:16px;
    top:50%;
    transform:translateY(-50%);
  }

  header .logo2-link img {
    height:40px;
    cursor:pointer;
  }

  header .logo2-link::after {
    content: "Alle Daten der Station";
    position: absolute;
    top: 120%;
    right: 0;              /* rechtsb√ºndig */
    transform: none;       /* keine Verschiebung */
    background: rgba(0,0,0,0.75);
    color: #fff;
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 0.8em;      /* gleiche Gr√∂√üe wie Symbole */
    font-style: normal;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
    z-index: 1000;
  }

  header .logo2-link:hover::after { opacity:1; }

  .stats-icon, .icon {
    display:inline-block;
    cursor:pointer;
    font-size:1em;
    color:#000;
    filter:grayscale(100%);
    margin-left:6px;
    position: relative;
  }

  .icon::after, .stats-icon::after {
    position: absolute;
    top: 120%;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.75);
    color: #fff;
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 0.8em;
    font-style: normal;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
    z-index: 1000;
  }

  .icon:hover::after { content: "Audio"; opacity:1; }
  .stats-icon:hover::after { content: "Statistik"; opacity:1; }

  .box { 
    background:#77C487; 
    margin:12px; 
    padding:12px; 
    border-radius:12px; 
    border:3px solid #333; 
  }

  .box h2 { font-size:1.1em; margin:0 0 8px; color:#333; }

  .row { display:flex; align-items:center; margin-bottom:10px; }
  .row img { width:64px; height:64px; object-fit:cover; border-radius:6px; margin-right:10px; border:2px solid #333; transition: transform 0.3s ease; }
  .row img:hover { transform: scale(1.75); }
  .row .info { flex:1; color:#333; }
  .row .info .name { font-weight:600; display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
  .row .info .name a { color:#333; text-decoration:none; }
  .row .info .name a:hover { text-decoration:underline; }
  .row .info .latin { font-style:italic; font-size:0.8em; margin-top:2px; display:flex; align-items:center; gap:6px; }
  .row .info .confidence { font-size:0.8em; margin-top:2px; color:#333; }     
  .inline-audio { vertical-align:middle; height:28px; }

  @media (max-width:480px){ 
    .row img{width:48px;height:48px;} 
    header{font-size:0.84em;} 
  }
</style>
</head>
<body>

<header>
  <img src="logo.png" alt="Logo" class="logo">
  <h1 class="header-text">BirdNET-pi Zirndorf</h1>
  <a href="https://app.birdweather.com/stations/13222" target="_blank" class="logo2-link">
    <img src="logo2.png" alt="Birdweather Logo">
  </a>
</header>

<div class="box" id="lastBox">
  <h2 id="lastHeader">Zuletzt geh√∂rt</h2>
  <div id="lastDetection"></div>
</div>

<div class="box" id="topBox">
  <h2>Die letzten Ges√§nge</h2>
  <div id="topList"></div>
</div>

<script>
const STATION_ID = 13222;
const API_KEY = "KcjgSB72LsSbc75LvEgbZLz7";
const BASE_URL = "https://app.birdweather.com/api/v1";

let todayDetectionsGlobal = [];

const translations = [

  { "de": "Alpenbraunelle",          "lat": "Prunella collaris" },
  { "de": "Alpendohle",             "lat": "Pyrrhocorax graculus" },
  { "de": "Alpenschneehuhn",        "lat": "Lagopus muta" },
  { "de": "Alpensegler",            "lat": "Tachymarptis melba" },
  { "de": "Alpenstrandl√§ufer",      "lat": "Calidris alpina" },
  { "de": "Amsel",                  "lat": "Turdus merula" },
  { "de": "Auerhuhn",               "lat": "Tetrao urogallus" },
  { "de": "Austernfischer",         "lat": "Haematopus ostralegus" },
  { "de": "Bachstelze",             "lat": "Motacilla alba" },
  { "de": "Bartgeier",              "lat": "Gypaetus barbatus" },
  { "de": "Bartmeise",              "lat": "Panurus biarmicus" },
  { "de": "Basst√∂lpel",             "lat": "Morus bassanus" },
  { "de": "Baumfalke",              "lat": "Falco subbuteo" },
  { "de": "Baumpieper",             "lat": "Anthus trivialis" },
  { "de": "Bekassine",              "lat": "Gallinago gallinago" },
  { "de": "Bergente",               "lat": "Aythya marila" },
  { "de": "Bergfink",               "lat": "Fringilla montifringilla" },
  { "de": "Bergh√§nfling",           "lat": "Linaria flavirostris" },
  { "de": "Berglaubs√§nger",         "lat": "Phylloscopus bonelli" },
  { "de": "Bergpieper",             "lat": "Anthus spinoletta" },
  { "de": "Beutelmeise",            "lat": "Remiz pendulinus" },
  { "de": "Bienenfresser",          "lat": "Merops apiaster" },
  { "de": "Birkenzeisig",           "lat": "Acanthis flammea" },
  { "de": "Birkhuhn",               "lat": "Lyrurus tetrix" },
  { "de": "Bl√§ssgans",              "lat": "Anser albifrons" },
  { "de": "Bl√§sshuhn",              "lat": "Fulica atra" },
  { "de": "Blaukehlchen",           "lat": "Luscinia svecica" },
  { "de": "Blaumeise",              "lat": "Cyanistes caeruleus" },
  { "de": "Bluth√§nfling",           "lat": "Carduelis cannabina" },
  { "de": "Brachpieper",            "lat": "Anthus campestris" },
  { "de": "Brachvogel",             "lat": "Numenius arquata" },
  { "de": "Brandgans",              "lat": "Tadorna tadorna" },
  { "de": "Brandseeschwalbe",       "lat": "Thalasseus sandvicensis" },
  { "de": "Braunkehlchen",          "lat": "Saxicola rubetra" },
  { "de": "Brautente",              "lat": "Aix sponsa" },
  { "de": "Bruchwasserl√§ufer",      "lat": "Tringa glareola" },
  { "de": "Buchfink",               "lat": "Fringilla coelebs" },
  { "de": "Buntspecht",             "lat": "Dendrocopos major" },
  { "de": "Dohle",                  "lat": "Corvus monedula" },
  { "de": "Dorngrasm√ºcke",          "lat": "Sylvia communis" },
  { "de": "Dreizehenm√∂we",          "lat": "Rissa tridactyla" },
  { "de": "Dreizehenspecht",        "lat": "Picoides tridactylus" },
  { "de": "Drosselrohrs√§nger",      "lat": "Acrocephalus arundinaceus" },
  { "de": "Dunkelwasserl√§ufer",     "lat": "Tringa erythropus" },
  { "de": "Dunkler Sturmtaucher",   "lat": "Ardenna grisea" },
  { "de": "Eichelh√§her",            "lat": "Garrulus glandarius" },
  { "de": "Eiderente",              "lat": "Somateria mollissima" },
  { "de": "Eisente",                "lat": "Clangula hyemalis" },
  { "de": "Eissturmvogel",          "lat": "Fulmarus glacialis" },
  { "de": "Eistaucher",             "lat": "Gavia immer" },
  { "de": "Eisvogel",               "lat": "Alcedo atthis" },
  { "de": "Elster",                 "lat": "Pica pica" },
  { "de": "Erlenzeisig",            "lat": "Spinus spinus" },
  { "de": "Falkenraubm√∂we",         "lat": "Stercorarius longicaudus" },
  { "de": "Feldlerche",             "lat": "Alauda arvensis" },
  { "de": "Feldschwirl",            "lat": "Locustella naevia" },
  { "de": "Feldsperling",           "lat": "Passer montanus" },
  { "de": "Felsenschwalbe",         "lat": "Ptyonoprogne rupestris" },
  { "de": "Fichtenkreuzschnabel",   "lat": "Loxia curvirostra" },
  { "de": "Fischadler",             "lat": "Pandion haliaetus" },
  { "de": "Fitis",                  "lat": "Phylloscopus trochilus" },
  { "de": "Flussregenpfeifer",      "lat": "Charadrius dubius" },
  { "de": "Flussseeschwalbe",       "lat": "Sterna hirundo" },
  { "de": "Flussuferl√§ufer",        "lat": "Actitis hypoleucos" },
  { "de": "G√§nses√§ger",             "lat": "Mergus merganser" },
  { "de": "Gartenbauml√§ufer",       "lat": "Certhia brachydactyla" },
  { "de": "Gartengrasm√ºcke",        "lat": "Sylvia borin" },
  { "de": "Gartenrotschwanz",       "lat": "Phoenicurus phoenicurus" },
  { "de": "Gelbbrauen-Laubs√§nger",  "lat": "Phylloscopus inornatus" },
  { "de": "Gelbsp√∂tter",            "lat": "Hippolais icterina" },
  { "de": "Gimpel",                 "lat": "Pyrrhula pyrrhula" },
  { "de": "Girlitz",                "lat": "Serinus serinus" },
  { "de": "Goldammer",              "lat": "Emberiza citrinella" },
  { "de": "Goldregenpfeifer",       "lat": "Pluvialis apricaria" },
  { "de": "Grauammer",              "lat": "Emberiza calandra" },
  { "de": "Graugans",               "lat": "Anser anser" },
  { "de": "Graureiher",             "lat": "Ardea cinerea" },
  { "de": "Grauschn√§pper",          "lat": "Muscicapa striata" },
  { "de": "Grauspecht",             "lat": "Picus canus" },
  { "de": "Gro√ütrappe",             "lat": "Otis tarda" },
  { "de": "Gr√ºnfink",               "lat": "Chloris chloris" },
  { "de": "Gr√ºnlaubs√§nger",         "lat": "Phylloscopus trochiloides" },
  { "de": "Gr√ºnschenkel",           "lat": "Tringa nebularia" },
  { "de": "Gr√ºnspecht",             "lat": "Picus viridis" },
  { "de": "Gryllteiste",            "lat": "Cepphus grylle" },
  { "de": "Habicht",                "lat": "Accipiter gentilis" },
  { "de": "Habichtskauz",           "lat": "Strix uralensis" },
  { "de": "Halsbandschn√§pper",      "lat": "Ficedula albicollis" },
  { "de": "Halsbandsittich",        "lat": "Psittacula krameri" },
  { "de": "Haselhuhn",              "lat": "Tetrastes bonasia" },
  { "de": "Haubenlerche",           "lat": "Galerida cristata" },
  { "de": "Haubenmeise",            "lat": "Lophophanes cristatus" },
  { "de": "Haubentaucher",          "lat": "Podiceps cristatus" },
  { "de": "Hausrotschwanz",         "lat": "Phoenicurus ochruros" },
  { "de": "Haussperling",           "lat": "Passer domesticus" },
  { "de": "Heckenbraunelle",        "lat": "Prunella modularis" },
  { "de": "Heidelerche",            "lat": "Lullula arborea" },
  { "de": "Heringsm√∂we",            "lat": "Larus fuscus" },
  { "de": "H√∂ckerschwan",           "lat": "Cygnus olor" },
  { "de": "Hohltaube",              "lat": "Columba oenas" },
  { "de": "Jagdfasan",              "lat": "Phasianus colchicus" },
  { "de": "Kampfl√§ufer",            "lat": "Philomachus pugnax" },
  { "de": "Kanadagans",             "lat": "Branta canadensis" },
  { "de": "Kernbei√üer",             "lat": "Coccothraustes coccothraustes" },
  { "de": "Kiebitz",                "lat": "Vanellus vanellus" },
  { "de": "Kiebitzregenpfeifer",    "lat": "Pluvialis squatarola" },
  { "de": "Kleiber",                "lat": "Sitta europaea" },
  { "de": "Kleinspecht",            "lat": "Dendrocopos minor" },
  { "de": "Kn√§kente",               "lat": "Anas querquedula" },
  { "de": "Kohlmeise",              "lat": "Parus major" },
  { "de": "Kolbenente",             "lat": "" },
  { "de": "Kolkrabe",               "lat": "Corvus corax" },
  { "de": "Kormoran",               "lat": "Phalacrocorax carbo" },
  { "de": "Kornweihe",              "lat": "Circus cyaneus" },
  { "de": "Krabbentaucher",         "lat": "" },
  { "de": "Kranich",                "lat": "Grus grus" },
  { "de": "Krickente",              "lat": "Anas crecca" },
  { "de": "Kuckuck",                "lat": "Cuculus canorus" },
  { "de": "K√ºstenseeschwalbe",      "lat": "" },
  { "de": "Kurzschnabelgans",       "lat": "" },
  { "de": "Lachm√∂we",               "lat": "Larus ridibundus" },
  { "de": "Lachseeschwalbe",        "lat": "" },
  { "de": "L√∂ffelente",             "lat": "Spatula clypeata" },
  { "de": "L√∂ffler",                "lat": "Platalea leucorodia" },
  { "de": "Mandarinente",           "lat": "Aix galericulata" },
  { "de": "Mantelm√∂we",             "lat": "Larus marinus" },
  { "de": "Mauerl√§ufer",            "lat": "Tichodroma muraria" },
  { "de": "Mauersegler",            "lat": "Apus apus" },
  { "de": "M√§usebussard",           "lat": "Buteo buteo" },
  { "de": "Meerstrandl√§ufer",       "lat": "" },
  { "de": "Mehlschwalbe",           "lat": "Delichon urbicum" },
  { "de": "Merlin",                 "lat": "Falco columbarius" },
  { "de": "Misteldrossel",          "lat": "Turdus viscivorus" },
  { "de": "Mittelmeerm√∂we",         "lat": "Larus michahellis" },
  { "de": "Mittels√§ger",            "lat": "Mergus serrator" },
  { "de": "Mittelspecht",           "lat": "Dendrocoptes medius" },
  { "de": "M√∂nchsgrasm√ºcke",        "lat": "Sylvia atricapilla" },
  { "de": "Moorente",               "lat": "Aythya nyroca" },
  { "de": "Mornellregenpfeifer",    "lat": "Charadrius morinellus" },
  { "de": "Nachtigall",             "lat": "Luscinia megarhynchos" },
  { "de": "Nachtreiher",            "lat": "Nycticorax nycticorax" },
  { "de": "Nandu",                  "lat": "Rhea americana" },
  { "de": "Nebelkr√§he",             "lat": "Corvus cornix" },
  { "de": "Neunt√∂ter",              "lat": "Lanius collurio" },
  { "de": "Nilgans",                "lat": "Alopochen aegyptiaca" },
  { "de": "Odinsh√ºhnchen",          "lat": "Phalaropus lobatus" },
  { "de": "Ohrenlerche",            "lat": "Eremophila alpestris" },
  { "de": "Ohrentaucher",           "lat": "Podiceps auritus" },
  { "de": "Orpheussp√∂tter",         "lat": "Hippolais polyglotta" },
  { "de": "Ortolan",                "lat": "Emberiza hortulana" },
  { "de": "Pfeifente",              "lat": "Mareca penelope" },
  { "de": "Pfuhlschnepfe",          "lat": "Limosa lapponica" },
  { "de": "Pirol",                  "lat": "Oriolus oriolus" },
  { "de": "Prachttaucher",          "lat": "Gavia arctica" },
  { "de": "Purpurreiher",           "lat": "Ardea purpurea" },
  { "de": "Rabenkr√§he",             "lat": "Corvus corone" },
  { "de": "Raubseeschwalbe",        "lat": "Hydroprogne caspia" },
  { "de": "Raubw√ºrger",             "lat": "Lanius excubitor" },
  { "de": "Rauchschwalbe",          "lat": "Hirundo rustica" },
  { "de": "Raufu√übussard",          "lat": "Buteo lagopus" },
  { "de": "Raufu√ükauz",             "lat": "Aegolius funereus" },
  { "de": "Rebhuhn",                "lat": "Perdix perdix" },
  { "de": "Regenbrachvogel",        "lat": "Numenius phaeopus" },
  { "de": "Reiherente",             "lat": "Aythya fuligula" },
  { "de": "Ringdrossel",            "lat": "Turdus torquatus" },
  { "de": "Ringelgans",             "lat": "Branta bernicla" },
  { "de": "Ringeltaube",            "lat": "Columba palumbus" },
  { "de": "Rohrammer",              "lat": "Emberiza schoeniclus" },
  { "de": "Rohrdommel",             "lat": "Botaurus stellaris" },
  { "de": "Rohrschwirl",            "lat": "Locustella luscinioides" },
  { "de": "Rohrweihe",              "lat": "Circus aeruginosus" },
  { "de": "Rostgans",               "lat": "Tadorna ferruginea" },
  { "de": "Rotdrossel",             "lat": "Turdus iliacus" },
  { "de": "Rothalstaucher",         "lat": "Podiceps grisegena" },
  { "de": "Rotkehlchen",            "lat": "Erithacus rubecula" },
  { "de": "Rotkehlpieper",          "lat": "Anthus cervinus" },
  { "de": "Rotkopfw√ºrger",          "lat": "Lanius senator" },
  { "de": "Rotmilan",               "lat": "Milvus milvus" },
  { "de": "Rotschenkel",            "lat": "Tringa totanus" },
  { "de": "Saatkr√§he",              "lat": "Corvus frugilegus" },
  { "de": "S√§belschn√§bler",         "lat": "Recurvirostra avosetta" },
  { "de": "Samtente",               "lat": "Melanitta fusca" },
  { "de": "Sanderling",             "lat": "Calidris alba" },
  { "de": "Sandregenpfeifer",       "lat": "Charadrius hiaticula" },
  { "de": "Schafstelze",            "lat": "Motacilla flava" },
  { "de": "Schellente",             "lat": "Bucephala clangula" },
  { "de": "Schilfrohrs√§nger",       "lat": "Acrocephalus schoenobaenus" },
  { "de": "Schlagschwirl",          "lat": "" },
  { "de": "Schleiereule",           "lat": "Tyto alba" },
  { "de": "Schmarotzerraubm√∂we",    "lat": "" },
  { "de": "Schnatterente",          "lat": "Anas querquedula" },
  { "de": "Schneeammer",            "lat": "Plectrophenax nivalis" },
  { "de": "Schneesperling",         "lat": "" },
  { "de": "Schreiadler",            "lat": "Aquila pomarina" },
  { "de": "Schwanzmeise",           "lat": "Aegithalos caudatus" },
  { "de": "Schwarzhalstaucher",     "lat": "Podiceps nigricollis" },
  { "de": "Schwarzkehlchen",        "lat": "Saxicola rubicola" },
  { "de": "Schwarzkopfm√∂we",        "lat": "" },
  { "de": "Schwarzmilan",           "lat": "Milvus migrans" },
  { "de": "Schwarzschwan",          "lat": "Cygnus atratus" },
  { "de": "Schwarzspecht",          "lat": "Dryocopus martius" },
  { "de": "Schwarzstorch",          "lat": "Ciconia nigra" },
  { "de": "Seeadler",               "lat": "Haliaeetus albicilla" },
  { "de": "Seeregenpfeifer",        "lat": "Charadrius alexandrinus" },
  { "de": "Seggenrohrs√§nger",       "lat": "Acrocephalus paludicola" },
  { "de": "Seidenreiher",           "lat": "Egretta garzetta" },
  { "de": "Seidenschwanz",          "lat": "Bombycilla garrulus" },
  { "de": "Sichelstrandl√§ufer",     "lat": "Calidris ferruginea" },
  { "de": "Silberm√∂we",             "lat": "Larus argentatus" },
  { "de": "Silberreiher",           "lat": "Ardea alba" },
  { "de": "Singdrossel",            "lat": "Turdus philomelos" },
  { "de": "Singschwan",             "lat": "Cygnus cygnus" },
  { "de": "Skua",                   "lat": "Stercorarius skua" },
  { "de": "Sommergoldh√§hnchen",     "lat": "Regulus ignicapilla" },
  { "de": "Spatelraubm√∂we",         "lat": "Stercorarius pomarinus" },
  { "de": "Sperber",                "lat": "Accipiter nisus" },
  { "de": "Sperbergrasm√ºcke",       "lat": "Sylvia nisoria" },
  { "de": "Sperlingskauz",          "lat": "Glaucidium passerinum" },
  { "de": "Spie√üente",              "lat": "Anas acuta" },
  { "de": "Spornammer",             "lat": "Calcarius lapponicus" },
  { "de": "Spornpieper",            "lat": "Anthus richardi" },
  { "de": "Sprosser",               "lat": "Luscinia luscinia" },
  { "de": "Star",                   "lat": "Sturnus vulgaris" },
  { "de": "Steinadler",             "lat": "Aquila chrysaetos" },
  { "de": "Steinhuhn",              "lat": "Alectoris graeca" },
  { "de": "Steinkauz",              "lat": "Athene noctua" },
  { "de": "Steinr√∂tel",             "lat": "Monticola saxatilis" },
  { "de": "Steinschm√§tzer",         "lat": "Oenanthe oenanthe" },
  { "de": "Steinw√§lzer",            "lat": "Arenaria interpres" },
  { "de": "Stelzenl√§ufer",          "lat": "Himantopus himantopus" },
  { "de": "Steppenm√∂we",            "lat": "Larus cachinnans" },
  { "de": "Sterntaucher",           "lat": "Gavia stellata" },
  { "de": "Stieglitz",              "lat": "Carduelis carduelis" },
  { "de": "Stockente",              "lat": "Anas platyrhynchos" },
  { "de": "Strandpieper",           "lat": "Anthus petrosus" },
  { "de": "Stra√üentaube",           "lat": "Columba livia" },
  { "de": "Sturmm√∂we",              "lat": "Larus canus" },
  { "de": "Sumpfl√§ufer",            "lat": "Calidris falcinellus" },
  { "de": "Sumpfmeise",             "lat": "Poecile palustris" },
  { "de": "Sumpfohreule",           "lat": "Asio flammeus" },
  { "de": "Sumpfrohrs√§nger",        "lat": "Acrocephalus palustris" },
  { "de": "Tafelente",              "lat": "Aythya ferina" },
  { "de": "Tannenh√§her",            "lat": "Nucifraga caryocatactes" },
  { "de": "Tannenmeise",            "lat": "Periparus ater" },
  { "de": "Teichhuhn",              "lat": "Gallinula chloropus" },
  { "de": "Teichrohrs√§nger",        "lat": "Acrocephalus scirpaceus" },
  { "de": "Teichwasserl√§ufer",      "lat": "Tringa stagnatilis" },
  { "de": "Temminckstrandl√§ufer",   "lat": "Calidris temminckii" },
  { "de": "Thorsh√ºhnchen",          "lat": "Phalaropus fulicarius" },
  { "de": "Tordalk",                "lat": "Alca torda" },
  { "de": "Trauerente",             "lat": "Melanitta nigra" },
  { "de": "Trauerschn√§pper",        "lat": "Ficedula hypoleuca" },
  { "de": "Trauerseeschwalbe",      "lat": "Chlidonias niger" },
  { "de": "Triel",                  "lat": "Burhinus oedicnemus" },
  { "de": "Trottellumme",           "lat": "Uria aalge" },
  { "de": "Tundrasaatgans",         "lat": "Anser serrirostris" },
  { "de": "T√ºpfelsumpfhuhn",        "lat": "Porzana porzana" },
  { "de": "T√ºrkentaube",            "lat": "Streptopelia decaocto" },
  { "de": "Turmfalke",              "lat": "Falco tinnunculus" },
  { "de": "Turteltaube",            "lat": "Streptopelia turtur" },
  { "de": "Uferschnepfe",           "lat": "Limosa limosa" },
  { "de": "Uferschwalbe",           "lat": "Riparia riparia" },
  { "de": "Uhu",                    "lat": "Bubo bubo" },
  { "de": "Wacholderdrossel",       "lat": "Turdus pilaris" },
  { "de": "Waldbauml√§ufer",         "lat": "Certhia familiaris" },
  { "de": "Waldkauz",               "lat": "Strix aluco" },
  { "de": "Waldlaubs√§nger",         "lat": "Phylloscopus sibilatrix" },
  { "de": "Waldohreule",            "lat": "Asio otus" },
  { "de": "Waldsaatgans",           "lat": "Anser fabalis" },
  { "de": "Waldschnepfe",           "lat": "Scolopax rusticola" },
  { "de": "Waldwasserl√§ufer",       "lat": "Tringa ochropus" },
  { "de": "Wanderfalke",            "lat": "Falco peregrinus" },
  { "de": "Wasseramsel",            "lat": "Cinclus cinclus" },
  { "de": "Wasserralle",            "lat": "Rallus aquaticus" },
  { "de": "Weidenmeise",            "lat": "Poecile montanus" },
  { "de": "Wei√übart-Seeschwalbe",   "lat": "Chlidonias hybrida" },
  { "de": "Wei√üfl√ºgel-Seeschwalbe", "lat": "Chlidonias leucopterus" },
  { "de": "Wei√ür√ºckenspecht",       "lat": "Dendrocopos leucotos" },
  { "de": "Wei√üstorch",             "lat": "Ciconia ciconia" },
  { "de": "Wei√üwangengans",         "lat": "Branta leucopsis" },
  { "de": "Wendehals",              "lat": "Jynx torquilla" },
  { "de": "Wiedehopf",              "lat": "Upupa epops" },
  { "de": "Wiesenpieper",           "lat": "Anthus pratensis" },
  { "de": "Wiesenweihe",            "lat": "Circus pygargus" },
  { "de": "Wintergoldh√§hnchen",     "lat": "Regulus regulus" },
  { "de": "Zaunammer",              "lat": "Emberiza cirlus" },
  { "de": "Zaunk√∂nig",              "lat": "Troglodytes troglodytes" },
  { "de": "Ziegenmelker / Nachtschwalbe", "lat": "Caprimulgus europaeus" },
  { "de": "Zilpzalp",               "lat": "Phylloscopus collybita" },
  { "de": "Zippammer",              "lat": "" },
  { "de": "Zitronengirlitz",        "lat": "Serinus citrinella" },
  { "de": "Zwergdommel",            "lat": "Ixobrychus minutus" },
  { "de": "Zwerggans",              "lat": "" },
  { "de": "Zwergm√∂we",              "lat": "" },
  { "de": "Zwergs√§ger",             "lat": "" },
  { "de": "Zwergschn√§pper",         "lat": "" },
  { "de": "Zwergschnepfe",          "lat": "" },
  { "de": "Zwergschwan",            "lat": "" },
  { "de": "Zwergseeschwalbe",       "lat": "" },
  { "de": "Zwergstrandl√§ufer",      "lat": "" },
  { "de": "Zwergsumpfhuhn",         "lat": "" },
  { de: "Zwergtaucher",           lat: "Tachybaptus ruficollis" }
    // ‚Ä¶ hier kannst du den Rest erg√§nzen
   
    ];

function getGermanName(latName) {
  const entry = translations.find(t => t.lat === latName);
  return entry ? entry.de : null;
}

async function loadDetections() {
  const url = `${BASE_URL}/stations/${STATION_ID}/detections?limit=100&api_key=${API_KEY}`;
  const res = await fetch(url, { headers: { "Accept":"application/json" } });
  const data = await res.json();

  if (Array.isArray(data?.detections)) {
    todayDetectionsGlobal = data.detections; // alle behalten
    renderAllDetections(todayDetectionsGlobal);
  }
}

function renderAllDetections(detections) {
  const lastEl = document.getElementById("lastDetection");
  const topEl = document.getElementById("topList");

  if (!detections.length) {
    lastEl.textContent = "Keine Detektionen.";
    topEl.innerHTML = "";
    return;
  }

  const last = detections.reduce((a, b) =>
    new Date(a.timestamp) > new Date(b.timestamp) ? a : b
  );
  renderLast(last);

  const grouped = new Map();
  for (const det of detections) {
    const key = det.species?.id ?? det.species?.commonName ?? "Unbekannt";
    if (!grouped.has(key)) {
      grouped.set(key, {
        common: det.species?.commonName ?? "Unbekannte Art",
        sci: det.species?.scientificName ?? "",
        thumb: det.species?.thumbnailUrl ?? "",
        count: 0,
        last: new Date(det.timestamp)
      });
    }
    const g = grouped.get(key);
    g.count++;
    const ts = new Date(det.timestamp);
    if (ts > g.last) g.last = ts;
  }

  const all = Array.from(grouped.values()).sort((a, b) => b.count - a.count);
  renderTop(all);
}

function renderLast(det) {
  const container = document.getElementById("lastDetection");
  container.innerHTML = "";
  const row = document.createElement("div");
  row.className = "row";
  const img = document.createElement("img");
  img.src = det.species?.thumbnailUrl ?? "";
  const info = document.createElement("div");
  info.className = "info";
  const name = document.createElement("div");
  name.className = "name";

  const german = getGermanName(det.species?.scientificName);
  const displayName = german ?? det.species?.commonName ?? "Unbekannte Art";

  const link = document.createElement("a");
  link.href = `https://de.wikipedia.org/wiki/${encodeURIComponent(displayName)}`;
  link.target = "_blank";
  link.textContent = displayName;
  name.appendChild(link);

  // Lautsprecher-Icon
  const icon = document.createElement("span");
  icon.className = "icon";
  icon.textContent = "üï©";
  icon.addEventListener("click", () => insertAndPlayAudioForSpecies(name, det.species?.scientificName));
  name.appendChild(icon);

  // Statistik-Icon
  const statsIcon = document.createElement("span");
  statsIcon.className = "stats-icon";
  statsIcon.textContent = "üìäÔ∏é";
  statsIcon.addEventListener("click", () => {
    window.open(`species.html?sci=${encodeURIComponent(det.species?.scientificName)}`, "_blank");
  });
  name.appendChild(statsIcon);

  const latin = document.createElement("div");
  latin.className = "latin";
  latin.textContent = det.species?.scientificName ?? "";

  const conf = Math.round((det.confidence ?? 0) * 100);
  const confLine = document.createElement("div");
  confLine.className = "confidence";
  confLine.textContent = `${conf}% Wahrscheinlichkeit`;

  info.appendChild(name);
  info.appendChild(latin);
  info.appendChild(confLine);
  row.appendChild(img);
  row.appendChild(info);
  container.appendChild(row);

  // Datum nur im Header
  const dt = new Date(det.timestamp);
  const header = document.getElementById("lastHeader");
  header.textContent = "Zuletzt geh√∂rt (" + dt.toLocaleString([], {
    hour: "2-digit",
    minute: "2-digit",
    day: "2-digit",
    month: "2-digit",
    year: "numeric"
  }) + ")";
}

function getLastDetectionForSpecies(sciName) {
  const matches = todayDetectionsGlobal.filter(
    d => d.species?.scientificName === sciName
  );
  if (!matches.length) return null;
  return matches.reduce((a, b) =>
    new Date(a.timestamp) > new Date(b.timestamp) ? a : b
  );
}

async function fetchSoundscapeNear(timestampIso) {
  const url = `${BASE_URL}/stations/${STATION_ID}/soundscapes?limit=10&api_key=${API_KEY}`;
  const res = await fetch(url, { headers: { "Accept":"application/json" } });
  const data = await res.json();

  if (!Array.isArray(data?.soundscapes) || !data.soundscapes.length) return null;

  const target = new Date(timestampIso).getTime();
  let best = null;
  let bestDelta = Infinity;
  for (const sc of data.soundscapes) {
    const t = new Date(sc.timestamp).getTime();
    const delta = Math.abs(t - target);
    if (delta < bestDelta) { bestDelta = delta; best = sc; }
  }
  return best;
}

async function insertAndPlayAudioForSpecies(nextToEl, sciName) {
  document.querySelectorAll('.inline-audio').forEach(a => a.remove());

  const lastDet = getLastDetectionForSpecies(sciName);
  if (!lastDet) {
    alert("Keine Detection f√ºr diese Art gefunden.");
    return;
  }

  const sc = await fetchSoundscapeNear(lastDet.timestamp);
  if (!sc) {
    alert("Kein Soundscape gefunden.");
    return;
  }

  const audio = document.createElement("audio");
  audio.className = "inline-audio";
  audio.src = sc.url;
  audio.controls = true;

  nextToEl.appendChild(audio);
  try { await audio.play(); } catch {}
}

function renderTop(list) {
  const container = document.getElementById("topList");
  container.innerHTML = "";
  for (const it of list) {
    const row = document.createElement("div");
    row.className = "row";
    const img = document.createElement("img");
    img.src = it.thumb;
    const info = document.createElement("div");
    info.className = "info";
    const name = document.createElement("div");
    name.className = "name";

    const german = getGermanName(it.sci);
    const displayName = german ?? it.common;

    const link = document.createElement("a");
    link.href = `https://de.wikipedia.org/wiki/${encodeURIComponent(displayName)}`;
    link.target = "_blank";
    link.textContent = `${displayName} (${it.count}x)`;
    name.appendChild(link);

    // Lautsprecher-Icon
    const icon = document.createElement("span");
    icon.className = "icon";
    icon.textContent = "üï©";
    icon.addEventListener("click", () => insertAndPlayAudioForSpecies(name, it.sci));
    name.appendChild(icon);

    // Statistik-Icon direkt daneben
    const statsIcon = document.createElement("span");
    statsIcon.className = "stats-icon";
    statsIcon.textContent = "üìäÔ∏é";
    statsIcon.addEventListener("click", () => {
      window.open(`species.html?sci=${encodeURIComponent(it.sci)}`, "_blank");
    });
    name.appendChild(statsIcon);

    const latin = document.createElement("div");
    latin.className = "latin";
    latin.textContent = it.sci + " (zuletzt: ";

    const timeSpan = document.createElement("span");
    timeSpan.textContent = it.last.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" }) + ")";
    latin.appendChild(timeSpan);

    info.appendChild(name);
    info.appendChild(latin);
    row.appendChild(img);
    row.appendChild(info);
    container.appendChild(row);
  }
}

window.addEventListener("DOMContentLoaded", async () => {
  await loadDetections();
  setInterval(() => location.reload(), 60000);
});
</script>
</body>
</html>

